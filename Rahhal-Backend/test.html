<!DOCTYPE html>
<html>
<head>
    <title>Chatbot Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        #log {
            width: 100%;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #msg {
            width: 70%;
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <h2>Chatbot Client</h2>
    <textarea id="log" rows="10" cols="80" readonly></textarea><br>
    <input type="text" id="msg" placeholder="Message..." />
    <button onclick="send()">Send</button>

    <!-- Required libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <script>
        const token = "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJ0b3VyaXN0QGdtYWlsLmNvbSIsImlhdCI6MTc1MDE3NTk5MywiZXhwIjoxMDc1MDE3NTk5M30.Hsrr53jDNIScxD4XTx3Y5oZKwgUXDQcXmKDCE7exy24cWoYwfb-I_HLtvxxn6vxQGryAn374yaz_47Lwj-2WVg";
        const userId = "21";
        const convId = "123";
        let stompClient;

        function log(message) {
            const logArea = document.getElementById("log");
            logArea.value += message + "\n";
            logArea.scrollTop = logArea.scrollHeight;
        }

        window.onload = function () {
            // Connect to WebSocket with token as query parameter
            const socket = new SockJS(`http://localhost:8088/ws/chatbot?token=${token}`);
            stompClient = Stomp.over(socket);

            // Enable debug logging temporarily
            stompClient.debug = function(str) {
                console.log("STOMP: " + str);
            };

            stompClient.connect(
                {}, // Empty headers since we're passing token in URL
                function (frame) {
                    console.log("Connected: " + frame);
                    log("Connected to WebSocket");

                    // Subscribe to user-specific queue
                    const subscription = stompClient.subscribe(`/user/${userId}/queue/conversation/${convId}`, function (message) {
                        console.log("Raw message received:", message);
                        console.log("Message body:", message.body);
                        console.log("Message headers:", message.headers);
                        
                        const isJson = message.headers.isJson === 'true';
                        let displayMessage;
                        
                        if (isJson) {
                            // If it's JSON, try to parse it
                            try {
                                const jsonMessage = JSON.parse(message.body);
                                displayMessage = jsonMessage.text || jsonMessage.message || JSON.stringify(jsonMessage);
                            } catch (e) {
                                console.error("Error parsing JSON message:", e);
                                displayMessage = message.body;
                            }
                        } else {
                            // If it's a string, use it directly
                            displayMessage = message.body;
                        }
                        
                        log("Bot: " + displayMessage);
                    });
                    console.log("Subscribed to:", `/user/${userId}/queue/conversation/${convId}`);

                    // Test subscription with a direct message
                    stompClient.send("/app/chatbot/send/" + userId + "/" + convId, {}, "Test message");
                },
                function (error) {
                    console.error("Connection error:", error);
                    log("Connection error: " + error);
                }
            );
        };

        function send() {
            const text = document.getElementById("msg").value;
            if (!text.trim()) return; // Don't send empty messages

            if (stompClient && stompClient.connected) {
                console.log("Sending message to:", `/app/chatbot/send/${userId}/${convId}`);
                console.log("Message content:", text);
                stompClient.send(`/app/chatbot/send/${userId}/${convId}`, {}, text);
                log("You: " + text);
                document.getElementById("msg").value = "";
            } else {
                console.error("Not connected to server");
                log("Not connected to server.");
            }
        }

        // Add enter key support
        document.getElementById("msg").addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                send();
            }
        });
    </script>
</body>
</html>